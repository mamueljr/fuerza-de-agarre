<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Encuesta Folstein (MMSE)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body>
    <h1>Test de Folstein (Mini-Mental)</h1>

    <!-- MODAL INICIAL -->
    <div id="modalInstrucciones" class="modal-overlay">
      <div class="modal-contenido">
        <p>
          A continuación, se le pedirá responder unas preguntas relacionadas con
          sus conocimientos generales.<br /><br />
          Le pido escuchar atentamente las instrucciones.<br /><br />
          Antes de iniciar ¿Tiene usted alguna duda o inquietud que le gustaría
          comentar o resolver?
        </p>
        <p style="text-align: center; font-weight: bold; margin-top: 20px">
          SI EL ADULTO MAYOR NO TIENE NINGUNA DUDA<br />
          OPRIMA EL BOTÓN OK.
        </p>
        <button onclick="cerrarModal()" class="guardar">OK</button>
      </div>
    </div>

    <!-- FORMULARIO -->
    <form id="formFolstein" class="form">
      <fieldset>
        <legend><strong>1. ¿En qué año estamos?</strong></legend>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p1', 1)"
        >
          Correcto
        </button>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p1', 0)"
        >
          Incorrecto
        </button>
      </fieldset>

      <fieldset>
        <legend><strong>2. ¿En qué estación estamos?</strong></legend>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p2', 1)"
        >
          Correcto
        </button>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p2', 0)"
        >
          Incorrecto
        </button>
      </fieldset>

      <fieldset>
        <legend><strong>3. ¿En qué día del mes estamos?</strong></legend>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p3', 1)"
        >
          Correcto
        </button>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p3', 0)"
        >
          Incorrecto
        </button>
      </fieldset>

      <fieldset>
        <legend><strong>4. ¿En qué mes estamos?</strong></legend>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p4', 1)"
        >
          Correcto
        </button>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p4', 0)"
        >
          Incorrecto
        </button>
      </fieldset>

      <fieldset>
        <legend><strong>5. ¿En qué día de la semana estamos?</strong></legend>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p5', 1)"
        >
          Correcto
        </button>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p5', 0)"
        >
          Incorrecto
        </button>
      </fieldset>

      <fieldset>
        <legend><strong>6. ¿En qué lugar estamos?</strong></legend>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p6', 1)"
        >
          Correcto
        </button>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p6', 0)"
        >
          Incorrecto
        </button>
      </fieldset>

      <fieldset>
        <legend><strong>7. ¿En qué piso o sala estamos?</strong></legend>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p7', 1)"
        >
          Correcto
        </button>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p7', 0)"
        >
          Incorrecto
        </button>
      </fieldset>

      <fieldset>
        <legend><strong>8. ¿En qué ciudad o pueblo estamos?</strong></legend>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p8', 1)"
        >
          Correcto
        </button>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p8', 0)"
        >
          Incorrecto
        </button>
      </fieldset>

      <fieldset>
        <legend><strong>9. ¿En qué municipio estamos?</strong></legend>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p9', 1)"
        >
          Correcto
        </button>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p9', 0)"
        >
          Incorrecto
        </button>
      </fieldset>

      <fieldset>
        <legend><strong>10. ¿En qué país estamos?</strong></legend>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p10', 1)"
        >
          Correcto
        </button>
        <button
          type="button"
          class="respuesta-btn"
          onclick="marcarRespuesta(this, 'p10', 0)"
        >
          Incorrecto
        </button>
      </fieldset>

      <div class="botones">
        <button type="button" class="guardar" onclick="guardarBackup()">
          Guardar respaldo
        </button>
        <button
          type="button"
          class="cancelar"
          onclick="location.href='../index.html'"
        >
          Cancelar
        </button>
        <button type="button" class="guardar" onclick="continuar()">
          Continuar con la segunda parte
        </button>
      </div>
    </form>

    <footer>ESISCOM &copy; 2025</footer>

    <script>
      const respuestas = {};

      function marcarRespuesta(boton, pregunta, valor) {
        respuestas[pregunta] = valor;
        const botones = boton.parentElement.querySelectorAll(".respuesta-btn");
        botones.forEach((btn) =>
          btn.classList.remove("correcto-activo", "incorrecto-activo")
        );
        if (valor === 1) {
          boton.classList.add("correcto-activo");
        } else {
          boton.classList.add("incorrecto-activo");
        }
      }

      function exportarCSV() {
        const registros = JSON.parse(
          localStorage.getItem("encuestados") || "[]"
        );

        const planos = registros.map((r) => {
          const plano = { ...r };
          if (typeof r.folstein === "object") {
            Object.entries(r.folstein).forEach(([k, v]) => {
              plano[`folstein_${k}`] = v;
            });
            delete plano.folstein;
          }
          return plano;
        });

        const encabezados = Array.from(
          planos.reduce((acc, obj) => {
            Object.keys(obj).forEach((k) => acc.add(k));
            return acc;
          }, new Set())
        );

        const filas = planos.map((obj) =>
          encabezados.map((k) => `"${obj[k] ?? ""}"`).join(",")
        );

        const csv = [encabezados.join(","), ...filas].join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "respaldo_encuestados.csv";
        a.click();
        URL.revokeObjectURL(url);
      }

      function guardarBackup() {
        exportarCSV();
        alert("Respaldo guardado.");
      }

      function cerrarModal() {
        document.getElementById("modalInstrucciones").style.display = "none";
      }

      function continuar() {
        const registros = JSON.parse(
          localStorage.getItem("encuestados") || "[]"
        );
        const ultimo = registros[registros.length - 1];

        if (!ultimo || !ultimo.id) {
          alert("No se encontró encuestado válido.");
          return;
        }

        // Guardar respuestas en el campo folstein
        if (!ultimo.folstein || typeof ultimo.folstein !== "object") {
          ultimo.folstein = {};
        }

        // Copiar respuestas del objeto temporal
        for (const [clave, valor] of Object.entries(respuestas)) {
          ultimo.folstein[clave] = valor;
        }

        localStorage.setItem("encuestados", JSON.stringify(registros));
        localStorage.setItem("encuestadoActual", ultimo.id);

        exportarCSV();
        window.location.href = "folstein2.html";
      }
    </script>
  </body>
</html>
